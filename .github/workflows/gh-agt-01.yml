name: gh-agt-01
on: 
  repository_dispatch:
    types: [gh-agt-01]
jobs:
  gh-agt-01:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      
      - name: Setup Docker
        uses: docker/setup-buildx-action@v2.0.0

      - name: Test Docker version
        run: docker --version

      - name: Prepare Dependency
        run: |
          ls -al .
          echo "${{ secrets.SSH_KEY_FOR_GITEE }}" > id_rsa && chmod 600 id_rsa
          conf=`echo ${{ github.event.client_payload.appConfig }} | base64 --decode`
          for repo in `echo $conf | jq -r '.[] | .repoName' | sort | uniq`
          do
            ls -la id_rsa && md5sum id_rsa
            [ ! -d "$repo" ] && GIT_SSH_COMMAND='ssh -i id_rsa -o StrictHostKeyChecking=no' git clone git@gitee.com:primtal/$repo.git
            for app in `echo $conf | jq -c ".[] | select(.repoName | contains(\"$repo\"))"`
            do
              appType=`echo $app | jq -r '.appType'`
              appName=`echo $app | jq -r '.appName'`
              if [ $appType == "Backend" ]; then
                [ ! -d "$HOME/.m2" ] && mkdir $HOME/.m2
                sed -i "s/ALIYUN_MAVEN_USERNAME/${{ secrets.ALIYUN_MAVEN_USERNAME }}/g" settings.xml 
                sed -i "s/ALIYUN_MAVEN_PASSWORD/${{ secrets.ALIYUN_MAVEN_PASSWORD }}/g" settings.xml 
                cp settings.xml $HOME/.m2/settings.xml 
                ls -la $HOME/.m2/settings.xml && md5sum $HOME/.m2/settings.xml
                docker run -i -v "$PWD/$repo/$appName":/usr/src/mymaven -v "$HOME/.m2":/root/.m2 -w /usr/src/mymaven vnnvanhuong/maven-oracle-jdk:8 mvn -q dependency:copy-dependencies
              elif [ $appType == "Frontend" ]; then
                docker run -i -v "$PWD/$repo/$appName":/usr/src/mynode -v "$HOME/node_modules":/root/node_modules -w /usr/src/mynode --env NODE_PATH=/root/node_modules node:10.16.0 sh -c "npm set unsafe-perm true && npm install"
              else
                echo "unsupported appType!"
              fi
              ls -al $HOME/.m2
              ls -al $HOME/
            done
          done

      - name: Install jenkins agent
        run: |
          wget ${{ github.event.client_payload.agt.downloadURL }}
          sudo mkdir -p /data/jenkins && sudo chown $USER: /data/jenkins
          java -jar agent.jar -jnlpUrl ${{ github.event.client_payload.agt.URL }} -secret "${{ github.event.client_payload.agt.key }}" -workDir "${{ github.event.client_payload.agt.workdir }}"
          
      - name: Don't kill instace
        run: sleep ${{ github.event.client_payload.keepalive }}
